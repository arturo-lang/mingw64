name: CI

on:
  push:
    branches: ["*"]
  pull_request:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            git python base-devel

      - name: Build and install package
        shell: msys2 {0}
        run: |
          set -euxo pipefail
          dos2unix PKGBUILD
          dos2unix 001-no-static-linking.patch
          MINGW_ARCH=ucrt64 makepkg-mingw -sif --noconfirm --noprogressbar --skippgpcheck

      - name: Debug and verify installation
        shell: msys2 {0}
        run: |
          set -euxo pipefail
          
          echo "============================================"
          echo "ENVIRONMENT VARIABLES"
          echo "============================================"
          echo "HOME: $HOME"
          echo "USER: $USER"
          echo "PWD: $(pwd)"
          echo "PATH: $PATH"
          echo ""
          
          echo "============================================"
          echo "HOME DIRECTORY RESOLUTION"
          echo "============================================"
          echo "~ expands to:"
          cd ~ && pwd
          echo "realpath of ~: $(realpath ~)"
          echo ""
          
          echo "============================================"
          echo "CHECK ~/.arturo DIRECTORY"
          echo "============================================"
          if [ -d ~/.arturo ]; then
            echo "~/.arturo exists"
            ls -la ~/.arturo/
          else
            echo "~/.arturo DOES NOT EXIST"
          fi
          echo ""
          
          echo "============================================"
          echo "CHECK ~/.arturo/bin DIRECTORY"
          echo "============================================"
          if [ -d ~/.arturo/bin ]; then
            echo "~/.arturo/bin exists"
            ls -la ~/.arturo/bin/
          else
            echo "~/.arturo/bin DOES NOT EXIST"
          fi
          echo ""
          
          # echo "============================================"
          # echo "CHECK ARTURO.EXE FILE"
          # echo "============================================"
          # if [ -f ~/.arturo/bin/arturo.exe ]; then
          #   echo "~/.arturo/bin/arturo.exe EXISTS"
          #   echo "File info:"
          #   ls -lh ~/.arturo/bin/arturo.exe
          #   echo "File type:"
          #   file ~/.arturo/bin/arturo.exe
          #   echo "Permissions:"
          #   stat -c "%a %n" ~/.arturo/bin/arturo.exe
          #   echo "Executable check:"
          #   test -x ~/.arturo/bin/arturo.exe && echo "File IS executable" || echo "File is NOT executable"
          # else
          #   echo "~/.arturo/bin/arturo.exe DOES NOT EXIST"
          # fi
          # echo ""
          
          echo "============================================"
          echo "SEARCH FOR ARTURO.EXE ANYWHERE"
          echo "============================================"
          echo "Looking in common locations:"
          find /opt -name "arturo.exe" 2>/dev/null || echo "Not found in /opt"
          find /usr -name "arturo.exe" 2>/dev/null || echo "Not found in /usr"
          find /mingw64 -name "arturo.exe" 2>/dev/null || echo "Not found in /mingw64"
          find /ucrt64 -name "arturo.exe" 2>/dev/null || echo "Not found in /mingw64"
          find "$HOME" -name "arturo.exe" 2>/dev/null || echo "Not found in HOME"
          echo ""
          
          echo "============================================"
          echo "CHECK IF arturo.exe IS IN PATH"
          echo "============================================"
          which arturo.exe || echo "arturo.exe not found in PATH"
          echo ""
          
          echo "============================================"
          echo "CHECK DLL DEPENDENCIES"
          echo "============================================"
          if [ -f /ucrt64/bin/arturo.exe ]; then
            echo "DLL dependencies:"
            ldd /ucrt64/bin/arturo.exe 2>&1 || echo "ldd failed"
          fi
          echo ""
          
          echo "============================================"
          echo "FINAL VERIFICATION ATTEMPT"
          echo "============================================"
          if [ -f /ucrt64/bin/arturo.exe ] && [ -x /ucrt64/bin/arturo.exe ]; then
            echo "File exists and is executable, attempting to run..."
            arturo.exe -v
            echo "SUCCESS!"
          else
            echo "FAILED: File does not exist or is not executable"
            exit 1
          fi